<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Atlas Chat Architecture</title>
    <style>
      :root {
        --bg: #f3f8f9;
        --panel: #ffffff;
        --ink: #10242f;
        --muted: #4e6878;
        --stroke: #d8e3e8;
      }
      body {
        margin: 0;
        font-family: "Segoe UI", Arial, sans-serif;
        color: var(--ink);
        background: linear-gradient(135deg, #eff7ff, #eefcf2);
      }
      .wrap {
        width: min(1200px, calc(100vw - 2rem));
        margin: 1.2rem auto 2rem;
      }
      .hero {
        background: var(--panel);
        border: 1px solid var(--stroke);
        border-radius: 18px;
        padding: 1rem 1.2rem;
        margin-bottom: 1rem;
      }
      h1 {
        margin: 0;
        font-size: 2rem;
      }
      p {
        margin: 0.5rem 0 0;
        color: var(--muted);
      }
      .grid {
        display: grid;
        gap: 1rem;
      }
      .card {
        background: var(--panel);
        border: 1px solid var(--stroke);
        border-radius: 18px;
        padding: 0.8rem;
      }
      .card h2 {
        margin: 0.2rem 0 0.8rem;
        padding: 0 0.4rem;
        font-size: 1.1rem;
      }
      .mermaid {
        background: #fbfdff;
        border: 1px solid var(--stroke);
        border-radius: 14px;
        padding: 0.4rem;
        overflow: auto;
      }
      ul {
        margin: 0.6rem 0 0.2rem;
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <section class="hero">
        <h1>Atlas Chat Architecture</h1>
        <p>
          Full-stack chat with file context and streamed xAI responses. PDF/text files follow
          extractor-first flow; images use direct multimodal model input.
        </p>
      </section>

      <div class="grid">
        <section class="card">
          <h2>System Topology</h2>
          <div class="mermaid">
flowchart LR
    U[User]
    FE[React Frontend<br/>Hooks + Axios + react-markdown]
    API[Main API<br/>FastAPI<br/>POST /api/chat]
    EX[Extractor Service<br/>FastAPI<br/>POST /extract]
    XAI[xAI Grok API<br/>OpenAI-compatible endpoint]

    U -->|Browser interactions| FE
    FE -->|Multipart request: prompt + optional file| API
    API -->|PDF/Text file| EX
    EX -->|Extracted text/metadata| API
    API -->|Prompt-only or multimodal call| XAI
    XAI -->|Streaming token chunks| API
    API -->|Chunked text stream| FE
    FE -->|Progressive rendering| U
          </div>
        </section>

        <section class="card">
          <h2>Request Sequence</h2>
          <div class="mermaid">
sequenceDiagram
    autonumber
    participant B as Browser (React)
    participant A as Main API (FastAPI)
    participant E as Extractor Service
    participant X as xAI (Grok)

    B->>A: POST /api/chat (prompt, temperature, optional file)
    alt File is PDF/Text
        A->>E: POST /extract (file)
        E-->>A: extracted content
        A->>A: build prompt with extracted context
        A->>X: chat.completions.create(stream=true)
    else File is Image
        A->>A: read image bytes and build base64 data URL
        A->>X: multimodal call (text + image_url, stream=true)
    else Prompt only
        A->>X: chat.completions.create(stream=true)
    end
    X-->>A: streamed chunks
    A-->>B: StreamingResponse(text/plain)
    B->>B: update UI as chunks arrive
          </div>
        </section>

        <section class="card">
          <h2>Design Choices</h2>
          <ul>
            <li>xAI was selected because an existing Grok key was already available.</li>
            <li>Image prompts go direct multimodal for better visual accuracy.</li>
            <li>Current scope is stateless; database can be added later.</li>
          </ul>
        </section>
      </div>
    </div>

    <script type="module">
      import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs";
      mermaid.initialize({
        startOnLoad: true,
        theme: "base",
        themeVariables: {
          fontFamily: "Segoe UI, Arial, sans-serif",
          fontSize: "15px",
          primaryColor: "#e9f7ff",
          primaryBorderColor: "#3d6f95",
          lineColor: "#3e6178",
          tertiaryColor: "#eef9f1",
          signalColor: "#2d638e"
        },
        sequence: {
          useMaxWidth: true,
          wrap: true
        },
        flowchart: {
          curve: "basis"
        }
      });
    </script>
  </body>
</html>
